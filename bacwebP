#!/usr/bin/python3
import os
import requests
import bs4
import sys
arguments = sys.argv

# -- GLOBAL VARIABLES --
optionList = [
    'Allemand',
    'Espagnol',
    'Russe',
    'chinois',
    'Turque',
    'Italien',
    'Ã\x89ducation Musicale',
    'Arts & Plastiques',
    'ThÃ©Ã¢tre'
    ]
sectionDict = {
    'math':      1,
    'science':   2,
    'economie':  3,
    'technique': 4,
    'lettres':   5,
    'sport':     6,
    'info':      7,
}

def main():
    global projectDir
    projectDir = initDir()
    mainPageSource = requests.get('http://www.bacweb.tn/section.htm')
    soup = bs4.BeautifulSoup(mainPageSource.text, 'html.parser')
    subjectList = soup.find_all('tbody')[0].find_all('tr')
    getSection(subjectList, sectionDict['science'])

def initDir():
    #create bac folder if it dosent exist and chdir into it
    if os.path.exists('bac') == False :
        os.makedirs('bac')
    os.chdir(os.getcwd() + '/bac')
    return os.getcwd() + '/'

def getSection(subjectList, sectionNum):
    for subject in subjectList:
        sectionList = subject.find_all('td')
        try:
            subjectName = sectionList[0].text
        else:
            sectionSubject = sectionList[sectionNum]
            if len(sectionSubject) != 0:
                linkToSubject = 'http://www.bacweb.tn/'+sectionSubject[0]['href']
                if subjectName in optionList:
                    # print('OPTION : '+subjectName)
                    pass
                else:
                    getSubject(linkToSubject, subjectName)

def getSubject(linkToSubject, subjectName):
    print(subjectName)
    subjectPageSource = requests.get(linkToSubject)
    soup = bs4.BeautifulSoup(subjectPageSource.text, 'html.parser')
    yearsContainer = soup.find_all('tbody')
    yearsList = soup.find_all('tr')
    for year in yearsList:
        subjectsByYear = year.find_all('td')
        try:
            yearNumber = int(subjectsByYear[0].text)
        else:
            getYear(yearNumber)

def getYear(yearNumber):
    yearNumberDir = str(yearNumber) + '/'
    if os.path.exists(projectDir+yearNumberDir) == False :
        os.makedirs(projectDir+yearNumberDir)

    os.chdir(projectDir+yearNumberDir)
    if os.path.exists(projectDir+yearNumberDir+'principale') == False :
        os.makedirs(projectDir+yearNumberDir+'principale')
    if os.path.exists(projectDir+yearNumberDir+'controle') == False :
        os.makedirs(projectDir+yearNumberDir+'controle')

    principale_sujet  = subjectsByYear[1].find_all('a')
    getSujet(principale_sujet, yearNumberDir, 'principale')

    principale_corrige = subjectsByYear[2].find_all('a')
    getSujet(principale_corrige, yearNumberDir, 'principale')

    controle_sujet = subjectsByYear[3].find_all('a')
    getSujet(controle_sujet, yearNumberDir, 'controle')

    controle_corrige = subjectsByYear[4].find_all('a')
    getSujet(controle_corrige, yearNumberDir, 'controle')

    os.chdir(projectDir)

def getSujet(sujet, yearNumberDir, promotion):
    if len(sujet) != 0:
        sujetLink = 'http://www.bacweb.tn/'+sujet[0]['href']
        p = sujetLink.rindex('/')
        sujetName = sujetLink[p+1:]
        os.chdir(projectDir+yearNumberDir+promotion)
        currentDir = os.getcwd()+'/'
        if os.path.exists(currentDir+sujetName) == False:
            os.system('curl -O '+sujetLink+' &> /dev/null')
        os.chdir(projectDir)


if __name__ == '__main__':
    main()
