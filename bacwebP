#!/usr/bin/python3
import os
import requests
import bs4
import sys
arguments = sys.argv

currentDir = os.getcwd()+'/'
#create bac folder if it dosent exist and chdir into it
if os.path.exists('bac') == False :
    os.makedirs('bac')
os.chdir(currentDir+'bac')

projectDir = os.getcwd()+'/'

optionList = [
    'Allemand',
    'Espagnol',
    'Russe',
    'chinois',
    'Turque',
    'Italien',
    'Ã\x89ducation Musicale',
    'Arts & Plastiques',
    'ThÃ©Ã¢tre'
    ]

mainPageSource = requests.get('http://www.bacweb.tn/section.htm')
soup = bs4.BeautifulSoup(mainPageSource.text, 'html.parser')
subjContainer = soup.find_all('tbody')
subjectList = subjContainer[0].find_all('tr')

for subject in subjectList:
    sectionList = subject.find_all('td')
    try:
        subjectName = sectionList[0].text
        ok1 = True
    except:
        ok1 = False

    if ok1:
        # sectionInfo = sectionList[7]
        # subjectExist = sectionInfo.select('a')
        # sectionMath = sectionList[1]
        # subjectExist = sectionMath.select('a')
        
        sectionScience = sectionList[2]
        subjectExist = sectionScience.select('a')

        if (len(subjectExist) != 0):
            linkToSubject = 'http://www.bacweb.tn/'+subjectExist[0]['href']
            if subjectName in optionList:
                # print('OPTION : '+subjectName)
                pass
            else:
                print(subjectName)
                subjectPageSource = requests.get(linkToSubject)
                soup2 = bs4.BeautifulSoup(subjectPageSource.text, 'html.parser')
                yearsContainer = soup2.find_all('tbody')
                yearsList = soup2.find_all('tr')
                for year in yearsList:
                    subjectsByYear = year.find_all('td')

                    try:
                        yearNumber = int(subjectsByYear[0].text)
                        ok2 = True
                    except:
                        ok2 = False

                    if ok2:
                        yearNumberDir = str(yearNumber)+'/'

                        if os.path.exists(projectDir+yearNumberDir) == False :
                            os.makedirs(projectDir+yearNumberDir)

                        os.chdir(projectDir+yearNumberDir)

                        if os.path.exists(projectDir+yearNumberDir+'principale') == False :
                            os.makedirs(projectDir+yearNumberDir+'principale')

                        if os.path.exists(projectDir+yearNumberDir+'controle') == False :
                            os.makedirs(projectDir+yearNumberDir+'controle')

                        principale_Sujet  = subjectsByYear[1].find_all('a')
                        if len(principale_Sujet) != 0:
                            link_principale_Sujet = 'http://www.bacweb.tn/'+principale_Sujet[0]['href']
                            sujName = link_principale_Sujet
                            p = sujName.rindex('/')
                            sujName = sujName[p+1:]
                            os.chdir(projectDir+yearNumberDir+'principale')
                            curDir = os.getcwd()+'/'
                            if os.path.exists(curDir+sujName) == False:
                                os.system('curl -O '+link_principale_Sujet+' &> /dev/null')
                            os.chdir(projectDir)

                        principale_Corige = subjectsByYear[2].find_all('a')
                        if len(principale_Corige) != 0:
                            link_principale_Corige = 'http://www.bacweb.tn/'+principale_Corige[0]['href']
                            sujName = link_principale_Corige
                            p = sujName.rindex('/')
                            sujName = sujName[p+1:]
                            os.chdir(projectDir+yearNumberDir+'principale')
                            curDir = os.getcwd()+'/'
                            if os.path.exists(curDir+sujName) == False:
                                os.system('curl -O '+link_principale_Corige+' &> /dev/null')
                            os.chdir(projectDir)

                        controle_Sujet   = subjectsByYear[3].find_all('a')
                        if len(controle_Sujet) != 0:
                            link_controle_Sujet = 'http://www.bacweb.tn/'+controle_Sujet[0]['href']
                            sujName = link_controle_Sujet
                            p = sujName.rindex('/')
                            sujName = sujName[p+1:]
                            os.chdir(projectDir+yearNumberDir+'controle')
                            curDir = os.getcwd()+'/'
                            if os.path.exists(curDir+sujName) == False:
                                os.system('curl -O '+link_controle_Sujet+' &> /dev/null')
                            os.chdir(projectDir)

                        controle_Corrige = subjectsByYear[4].find_all('a')
                        if len(controle_Corrige) != 0:
                            link_controle_Corrige = 'http://www.bacweb.tn/'+controle_Corrige[0]['href']
                            sujName = link_controle_Corrige
                            p = sujName.rindex('/')
                            sujName = sujName[p+1:]
                            os.chdir(projectDir+yearNumberDir+'controle')
                            curDir = os.getcwd()+'/'
                            if os.path.exists(curDir+sujName) == False:
                                os.system('curl -O '+link_controle_Corrige+' &> /dev/null')
                            os.chdir(projectDir)

                        os.chdir(projectDir)
